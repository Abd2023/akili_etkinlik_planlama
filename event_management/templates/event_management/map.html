{% extends "base.html" %}

{% block title %}Event Map{% endblock %}

{% block content %}
<h1>Event Map with Route Planning</h1>
<form id="routeForm">
    <label for="mode">Transportation Mode:</label>
    <select id="mode">
        <option value="DRIVING">Driving</option>
        <option value="WALKING">Walking</option>
        <option value="BICYCLING">Cycling</option>
    </select>
    <button type="button" id="findRoute">Find Route</button>
</form>
<div id="map" style="height: 500px; width: 100%;"></div>

<script>
    // Parse events passed from the backend
    const events = JSON.parse(`{{ events|escapejs }}`);

    const map = L.map('map').setView([39.9208, 32.8541], 6); // Default location: Ankara

    // Add OpenStreetMap tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
    }).addTo(map);

    // Add markers for events
    events.forEach(event => {
        if (event.latitude && event.longitude) {
            const marker = L.marker([event.latitude, event.longitude]).addTo(map).bindPopup(`
                <div>
                    <h3>${event.name}</h3>
                    <p><strong>Location:</strong> ${event.location}</p>
                    <p><strong>Date:</strong> ${event.date || 'N/A'}</p>
                    <p><strong>Time:</strong> ${event.start_time || 'N/A'}</p>
                    <p><strong>Description:</strong> ${event.description || 'No description provided.'}</p>
                </div>
            `);

            // Allow setting the destination marker by double-clicking an event marker
            marker.on('dblclick', () => {
                endMarker.setLatLng(marker.getLatLng());
            });
        }
    });

    // Start and Destination markers
    const startMarker = L.marker([39.914, 32.850], { draggable: true }).addTo(map).bindPopup('Start');
    const endMarker = L.marker([39.9208, 32.8541], { draggable: true }).addTo(map).bindPopup('Destination');

    // Find route functionality using OSRM Routing API
    document.getElementById('findRoute').addEventListener('click', () => {
        const start = startMarker.getLatLng();
        const end = endMarker.getLatLng();
        const mode = document.getElementById('mode').value;

        // Routing API URL
        const apiUrl = `https://router.project-osrm.org/route/v1/${mode.toLowerCase()}/${start.lng},${start.lat};${end.lng},${end.lat}?overview=full&geometries=geojson`;

        fetch(apiUrl)
            .then(response => response.json())
            .then(data => {
                if (data.routes && data.routes.length > 0) {
                    const route = data.routes[0];
                    const coordinates = route.geometry.coordinates.map(coord => [coord[1], coord[0]]);

                    // Draw the route on the map
                    L.polyline(coordinates, { color: 'blue' }).addTo(map);
                } else {
                    alert('Could not calculate route. Please check your inputs.');
                }
            })
            .catch(error => {
                console.error('Error fetching route:', error);
                alert('Could not calculate route. Please check your inputs.');
            });
    });
</script>


{% endblock %}

<!DOCTYPE html>
<html>
    <head>
        <title>Event Map with Route Planning</title>
        <script src="https://maps.gomaps.pro/maps/api/js?key={{ google_maps_api_key }}"></script>
    </head>
<body>
    <h1>Event Map</h1>
    <form id="routeForm">
        <label for="mode">Transportation Mode:</label>
        <select id="mode">
            <option value="DRIVING">Driving</option>
            <option value="WALKING">Walking</option>
            <option value="BICYCLING">Cycling</option>
        </select>
        <button type="button" id="findRoute">Find Route</button>
    </form>
    <div id="map" style="height: 500px; width: 100%;"></div>
    <script>
        let map, directionsService, directionsRenderer, startMarker, endMarker;
        function initMap() {
            // Parse events passed from the backend
            const events = JSON.parse('{{ events|escapejs }}');
            const defaultLocation = { lat: 39.9208, lng: 32.8541 }; // Default location: Ankara

            // Initialize the map
            map = new google.maps.Map(document.getElementById('map'), {
                center: defaultLocation,
                zoom: 6
            });

            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer();
            directionsRenderer.setMap(map);

            // Add draggable markers for start and destination
            startMarker = new google.maps.Marker({
                position: { lat: 39.914, lng: 32.850 }, // Example starting point
                map: map,
                draggable: true,
                label: "Start",
            });

            endMarker = new google.maps.Marker({
                position: defaultLocation,
                map: map,
                draggable: true,
                label: "Destination",
            });

            document.getElementById("findRoute").addEventListener("click", () => {
                calculateRoute();
            });

            // Loop through events and create markers
            events.forEach(event => {
                const marker = new google.maps.Marker({
                    position: { lat: parseFloat(event.latitude), lng: parseFloat(event.longitude) },
                    map: map,
                    title: event.name
                });

                // Add an info window for each marker with event details
                const infowindow = new google.maps.InfoWindow({
                    content: `
                        <div>
                            <h3>${event.name}</h3>
                            <p><strong>Location:</strong> ${event.location}</p>
                            <p><strong>Date:</strong> ${event.date || 'N/A'}</p>
                            <p><strong>Time:</strong> ${event.start_time || 'N/A'}</p>
                            <p><strong>Description:</strong> ${event.description || 'No description provided.'}</p>
                        </div>
                    `
                });

                marker.addListener('click', () => {
                    infowindow.open(map, marker);
                });

                // Allow setting the destination marker by clicking an event
                marker.addListener('dblclick', () => {
                    endMarker.setPosition(marker.getPosition());
                });
            });
        }

        function calculateRoute() {
            const start = startMarker.getPosition();
            const end = endMarker.getPosition();
            const mode = document.getElementById("mode").value;

            const request = {
                origin: start,
                destination: end,
                travelMode: google.maps.TravelMode[mode],
            };

            directionsService.route(request, (result, status) => {
                if (status === google.maps.DirectionsStatus.OK) {
                    directionsRenderer.setDirections(result);
                } else {
                    alert("Could not calculate route. Please check your inputs.");
                }
            });
        }

        // Initialize the map
        window.onload = initMap;
    </script>
</body>
</html>
